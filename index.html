<script>
  AFRAME.registerComponent('draggable', {
    init: function () {
      this.ifMouseDown = false;
      this.initialCoord = {x: 0, y: 0};
      this.initialRotation = {x: 0, y: 0};
      this.initialPosition = {x: 0, y: 0, z: 0};

      this.onMouseDown = this.onMouseDown.bind(this);
      this.onMouseMove = this.onMouseMove.bind(this);
      this.onMouseUp = this.onMouseUp.bind(this);
      this.onTouchStart = this.onTouchStart.bind(this);
      this.onTouchMove = this.onTouchMove.bind(this);
      this.onTouchEnd = this.onTouchEnd.bind(this);

      this.el.addEventListener('mousedown', this.onMouseDown);
      this.el.addEventListener('touchstart', this.onTouchStart);
      window.addEventListener('mouseup', this.onMouseUp);
      window.addEventListener('touchend', this.onTouchEnd);
      this.el.addEventListener('mousemove', this.onMouseMove);
      this.el.addEventListener('touchmove', this.onTouchMove);
    },
    remove: function () {
      this.el.removeEventListener('mousedown', this.onMouseDown);
      this.el.removeEventListener('touchstart', this.onTouchStart);
      window.removeEventListener('mouseup', this.onMouseUp);
      window.removeEventListener('touchend', this.onTouchEnd);
      this.el.removeEventListener('mousemove', this.onMouseMove);
      this.el.removeEventListener('touchmove', this.onTouchMove);
    },
    onMouseDown: function (event) {
      this.ifMouseDown = true;
      this.initialCoord.x = event.clientX;
      this.initialCoord.y = event.clientY;
      this.initialRotation = this.el.getAttribute('rotation');
      this.initialPosition = this.el.getAttribute('position');
    },
    onMouseMove: function (event) {
      if (!this.ifMouseDown) return;
      var deltaX = event.clientX - this.initialCoord.x;
      var deltaY = event.clientY - this.initialCoord.y;
      this.el.setAttribute('rotation', {
        x: this.initialRotation.x - deltaY * 0.1,
        y: this.initialRotation.y + deltaX * 0.1,
        z: this.initialRotation.z
      });
    },
    onMouseUp: function () {
      this.ifMouseDown = false;
    },
    onTouchStart: function (event) {
      if (event.touches.length == 1) {
        this.ifMouseDown = true;
        this.initialCoord.x = event.touches[0].clientX;
        this.initialCoord.y = event.touches[0].clientY;
        this.initialRotation = this.el.getAttribute('rotation');
      } else if (event.touches.length == 2) {
        this.ifMouseDown = true;
        this.initialCoord.x = (event.touches[0].clientX + event.touches[1].clientX) / 2;
        this.initialCoord.y = (event.touches[0].clientY + event.touches[1].clientY) / 2;
        this.initialPosition = this.el.getAttribute('position');
      }
    },
    onTouchMove: function (event) {
      if (!this.ifMouseDown || event.touches.length == 0) return;

      if (event.touches.length == 1) {
        var deltaX = event.touches[0].clientX - this.initialCoord.x;
        var deltaY = event.touches[0].clientY - this.initialCoord.y;
        this.el.setAttribute('rotation', {
          x: this.initialRotation.x - deltaY * 0.1,
          y: this.initialRotation.y + deltaX * 0.1,
          z: this.initialRotation.z
        });
      } else if (event.touches.length == 2) {
        var currentCoordX = (event.touches[0].clientX + event.touches[1].clientX) / 2;
        var currentCoordY = (event.touches[0].clientY + event.touches[1].clientY) / 2;
        var deltaX = currentCoordX - this.initialCoord.x;
        var deltaY = currentCoordY - this.initialCoord.y;
        this.el.setAttribute('position', {
          x: this.initialPosition.x + deltaX * 0.01,
          y: this.initialPosition.y,
          z: this.initialPosition.z + deltaY * 0.01
        });
      }
    },
    onTouchEnd: function () {
      this.ifMouseDown = false;
    }
  });
</script>

